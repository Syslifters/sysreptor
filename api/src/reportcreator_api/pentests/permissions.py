from django.conf import settings
from rest_framework import permissions

from reportcreator_api.utils import license
from reportcreator_api.pentests.models import ProjectTypeScope, SourceEnum


class IsAuthenticatedOrRetrieve(permissions.IsAuthenticated):
    def has_permission(self, request, view):
        if view.action and view.action.startswith('retrieve'):
          return True
        return super().has_permission(request, view)


class ProjectTypePermissions(permissions.BasePermission):
    # Read-only actions that can be performed by anyone having read permissions
    # and actions for private designs (permission check done in serializer to allow only private designs)
    public_actions = ['preview', 'export', 'copy', 'create', 'import_']
    # Write actions on a ProjectType instance
    private_actions = ['update', 'partial_update', 'destroy', 'lock', 'unlock']
    # All other actions are only accessible for users with designer permissions

    def has_permission(self, request, view):
        if request.user.is_admin or request.user.is_designer:
            return True
        if request.method in permissions.SAFE_METHODS or view.action in self.public_actions + self.private_actions:
            return True
        return False
    
    def has_object_permission(self, request, view, obj):
        if request.user.is_admin:
            return True
        if obj.scope == ProjectTypeScope.GLOBAL:
            return request.method in permissions.SAFE_METHODS or view.action in self.public_actions or \
                request.user.is_designer
        elif obj.scope == ProjectTypeScope.PRIVATE:
            return obj.linked_user == request.user and settings.ENABLE_PRIVATE_DESIGNS
        elif obj.scope == ProjectTypeScope.PROJECT:
            if request.user not in set(map(lambda m: m.user, obj.linked_project.members.all())):
                return False
            return request.method in permissions.SAFE_METHODS or view.action in self.public_actions or \
                (view.action in self.private_actions and obj.source == SourceEnum.CUSTOMIZED) or \
                (request.user.is_designer and obj.source == SourceEnum.CUSTOMIZED)
        return False


class ProjectTypeSubresourcePermissions(permissions.BasePermission):
    def has_permission(self, request, view):
        if request.user.is_admin:
            return True
        project_type = view.get_project_type()
        if project_type.scope == ProjectTypeScope.GLOBAL:
            return request.method in permissions.SAFE_METHODS or \
                request.user.is_designer
        elif project_type.scope == ProjectTypeScope.PRIVATE:
            return project_type.linked_user == request.user and settings.ENABLE_PRIVATE_DESIGNS
        elif project_type.scope == ProjectTypeScope.PROJECT:
            if request.user not in set(map(lambda m: m.user, project_type.linked_project.members.all())):
                return False
            return request.method in permissions.SAFE_METHODS or \
                project_type.source in [SourceEnum.CUSTOMIZED]
        return False


class IsTemplateEditorOrReadOnly(permissions.BasePermission):
    def has_permission(self, request, view):
        return request.method in permissions.SAFE_METHODS or request.user.is_admin or request.user.is_template_editor


class ProjectPermissions(permissions.BasePermission):
    def has_permission(self, request, view):
        if request.user.is_guest:
            if not settings.GUEST_USERS_CAN_CREATE_PROJECTS and view.action in ['create', 'copy', 'import_']:
                return False
            elif not settings.GUEST_USERS_CAN_IMPORT_PROJECTS and view.action in ['import_']:
                return False
            elif not settings.GUEST_USERS_CAN_DELETE_PROJECTS and view.action in ['destroy']:
                return False
            elif not settings.GUEST_USERS_CAN_UPDATE_PROJECT_SETTINGS and view.action in ['update', 'partial_update', 'readonly', 'customize_projecttype', 'archive', 'archive_check']:
                return False
        
        if view.action in ['archive_check', 'archive'] and not license.ProfessionalLicenseRequired().has_permission(request, view):
            return False
        return True

    def has_object_permission(self, request, view, obj):
        if request.method in permissions.SAFE_METHODS or view.action in ['check', 'preview', 'generate', 'copy', 'export', 'export_all', 'readonly', 'archive', 'archive_check', 'destroy']:
            return True
        return not obj.readonly


class ProjectSubresourcePermissions(permissions.BasePermission):
    def has_permission(self, request, view):
        if request.method in permissions.SAFE_METHODS:
            return True
        return not view.get_project().readonly


class UserPublicKeyPermissions(permissions.BasePermission):
    def has_permission(self, request, view):
        if view.kwargs.get('pentestuser_pk') == 'self':
            return True
        if request.user.is_admin or request.user.is_user_manager:
            return request.method in permissions.SAFE_METHODS
        return False


class ArchivedProjectKeyPartPermissions(permissions.BasePermission):
    def has_object_permission(self, request, view, obj):
        if view.action in ['public_key_encrypted_data', 'decrypt']:
            return request.user.is_admin or request.user == obj.user
        return True
